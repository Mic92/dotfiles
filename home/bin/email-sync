#!/usr/bin/env bash
# email-sync - Sync emails from IMAP and tag with afew

set -euo pipefail

# Sync emails from IMAP servers (folders already organized by Sieve)
echo "Syncing emails from IMAP servers..."
mbsync -a

# Initialize notmuch if needed
if [ ! -d "$HOME/mail/.notmuch" ]; then
    echo "Initializing notmuch database..."
    notmuch new
fi

# Index new emails
echo "Indexing new emails..."
notmuch new

# The post-new hook will run afew automatically to tag emails
# based on the filters in ~/.config/afew/config

# Run afew to tag new emails (including verification codes)
echo "Tagging emails with afew..."
afew -tn

# Clean up old CI failure notifications (but keep regular GitHub notifications)
echo "Cleaning up old CI failures..."
notmuch tag +trash -- 'tag:ci AND date:..2days'

# Clean up old verification codes and magic links (now using the verification-code tag)
echo "Cleaning up old verification codes and magic links..."
notmuch tag +trash -- 'tag:verification-code AND date:..1week'

# Clean up old calendar emails (older than 1 year)
echo "Cleaning up old calendar emails..."
notmuch tag +trash -- 'tag:calendar AND NOT tag:calendar-reminder AND date:..1year'

# Clean up old calendar reminders (older than 2 days)
echo "Cleaning up old calendar reminders..."
notmuch tag +trash -- 'tag:calendar-reminder AND date:..2days'

# Send desktop notifications for new emails (if in graphical session)
if [ -n "${DISPLAY:-}" ] || [ -n "${WAYLAND_DISPLAY:-}" ]; then
    echo "Checking for new email notifications..."
    
    # Query for new emails in inbox folders from the last 7 days
    # that haven't been notified yet
    NEW_EMAILS=$(notmuch search --output=messages '(folder:thalheim.io OR folder:Entwickler OR folder:Netzwerke OR folder:Benachrichtigung OR folder:Geld OR folder:Privat OR folder:Arbeit OR folder:Uni) AND date:7d.. AND NOT tag:notified AND NOT tag:trash' 2>/dev/null || true)
    
    if [ -n "$NEW_EMAILS" ]; then
        # Process each new email
        while IFS= read -r msg_id; do
            # Get email details
            FROM=$(notmuch show --format=json "$msg_id" | jq -r '.[0][0][0].headers.From' | sed 's/<.*>//g' | xargs)
            SUBJECT=$(notmuch show --format=json "$msg_id" | jq -r '.[0][0][0].headers.Subject')
            
            # Send desktop notification
            notify-send "New Email" "$FROM: $SUBJECT" --icon=mail-unread
            
            # Mark as notified so we don't notify again
            notmuch tag +notified -- "$msg_id"
        done <<< "$NEW_EMAILS"
    fi
fi
