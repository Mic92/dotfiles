#!/usr/bin/env bash
# email-sync - Sync emails from IMAP and tag with afew

set -euo pipefail

# Sync emails from IMAP servers (folders already organized by Sieve)
echo "Syncing emails from IMAP servers..."
mbsync -a

# Initialize notmuch if needed
if [ ! -d "$HOME/mail/.notmuch" ]; then
    echo "Initializing notmuch database..."
    notmuch new
fi

# Index new emails
echo "Indexing new emails..."
notmuch new

# The post-new hook will run afew automatically to tag emails
# based on the filters in ~/.config/afew/config

# Run afew to tag new emails (including verification codes)
echo "Tagging emails with afew..."
afew -tn

# Clean up old CI failure notifications (but keep regular GitHub notifications)
echo "Cleaning up old CI failures..."
notmuch tag +trash -- 'tag:ci AND date:..2days'

# Clean up old verification codes and magic links (now using the verification-code tag)
echo "Cleaning up old verification codes and magic links..."
notmuch tag +trash -- 'tag:verification-code AND date:..1week'
