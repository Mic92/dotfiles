#!/usr/bin/env bash
# email-sync - Sync emails from IMAP and tag with afew

set -euo pipefail

# Sync emails from IMAP servers (folders already organized by Sieve)
echo "Syncing emails from IMAP servers..."
mbsync -a

# Initialize notmuch if needed
if [ ! -d "$HOME/mail/.notmuch" ]; then
    echo "Initializing notmuch database..."
    notmuch new
fi

# Index new emails
echo "Indexing new emails..."
notmuch new

# The post-new hook will run afew automatically to tag emails
# based on the filters in ~/.config/afew/config

# Clean up old CI failure notifications (but keep regular GitHub notifications)
echo "Cleaning up old CI failures..."
notmuch tag +trash -- 'tag:ci AND from:notifications@github.com AND (subject:"Run failed" OR subject:"Run cancelled") AND date:..2days'